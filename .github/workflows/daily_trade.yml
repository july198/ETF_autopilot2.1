name: ETF Auto Trader

on:
  workflow_dispatch:
  schedule:
    # 北京时间 08:50（UTC 00:50）周一到周五
    - cron: "50 0 * * 1-5"
    # 北京时间 09:10（UTC 01:10）周一到周五（保险）
    - cron: "10 1 * * 1-5"

jobs:
  run_daily:
    runs-on: ubuntu-latest

    env:
      TZ: Asia/Shanghai
      # 脚本读取的环境变量名（不改你的 secrets 名称）
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASSWORD }}
      SMTP_TO: ${{ secrets.TO_EMAIL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 用北京时间日期作为 key
      - name: Compute today key (Beijing)
        id: today
        run: |
          echo "TODAY=$(date +%F)" >> $GITHUB_OUTPUT
          echo "Beijing TODAY=$(date +%F) NOW=$(date '+%F %T %z')"

      # 以“日期”为 key 的 cache：命中就表示今天已发过
      - name: Restore sent-flag cache (today)
        id: cache
        uses: actions/cache@v4
        with:
          path: .sent-flag
          key: sent-flag-${{ github.repository }}-${{ github.ref_name }}-${{ steps.today.outputs.TODAY }}

      - name: Check already sent today
        id: checksent
        run: |
          mkdir -p .sent-flag
          TODAY="${{ steps.today.outputs.TODAY }}"
          # 手动触发时允许你主动再发（不受今日标记限制）
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ALREADY_SENT=0" >> $GITHUB_OUTPUT
            echo "Manual run: allow sending."
            exit 0
          fi

          if [ -f ".sent-flag/${TODAY}.ok" ]; then
            echo "ALREADY_SENT=1" >> $GITHUB_OUTPUT
            echo "Already sent today: ${TODAY}"
          else
            echo "ALREADY_SENT=0" >> $GITHUB_OUTPUT
            echo "Not sent yet today: ${TODAY}"
          fi

      # 如果今天已发过：临时把 config.yaml 的 email.enabled 关掉，避免第二封
      - name: Disable email in config.yaml (if already sent)
        if: steps.checksent.outputs.ALREADY_SENT == '1'
        run: |
          python - <<'PY'
          import yaml
          p = "config.yaml"
          with open(p, "r", encoding="utf-8") as f:
              cfg = yaml.safe_load(f)
          # notify.email.enabled = false
          cfg.setdefault("notify", {}).setdefault("email", {})["enabled"] = False
          with open(p, "w", encoding="utf-8") as f:
              yaml.safe_dump(cfg, f, allow_unicode=True, sort_keys=False)
          print("Disabled notify.email.enabled for this run.")
          PY

      - name: Check email env (length only)
        run: |
          python - <<'PY'
          import os
          for k in ["SMTP_USER","SMTP_PASS","SMTP_TO"]:
              v = os.getenv(k, "")
              print(f"{k}: {'OK' if v else 'MISSING'} len={len(v)}")
          PY

      # 运行脚本（脚本会发你想要的那封“日报格式”邮件）
      - name: Run daily trader script
        run: |
          python ./scripts/run_daily.py

      # 如果今天没发过：写标记文件，cache 会在 job 结束时自动保存
      - name: Mark sent today
        if: steps.checksent.outputs.ALREADY_SENT != '1'
        run: |
          TODAY="${{ steps.today.outputs.TODAY }}"
          mkdir -p .sent-flag
          echo "ok" > ".sent-flag/${TODAY}.ok"
          echo "Marked sent: ${TODAY}"
