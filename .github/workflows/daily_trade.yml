name: ETF Auto Trader

on:
  workflow_dispatch:
  schedule:
    # 北京时间 09:00（UTC 01:00）周一到周五
    - cron: "0 1 * * 1-5"

jobs:
  run_daily:
    runs-on: ubuntu-latest

    env:
      TZ: Asia/Shanghai
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASSWORD }}
      SMTP_TO: ${{ secrets.TO_EMAIL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 只打印长度，不泄露内容
      - name: Check email env (length only)
        run: |
          python - <<'PY'
          import os
          for k in ["SMTP_USER","SMTP_PASS","SMTP_TO"]:
              v = os.getenv(k, "")
              print(f"{k}: {'OK' if v else 'MISSING'} len={len(v)}")
          PY

      # 运行主脚本：失败就重试（最多3次）
      - name: Run daily trader script (retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 30
          command: python ./scripts/run_daily.py

      # 兜底邮件：失败就重试（最多3次）
      - name: Send email fallback via QQ SMTP (retry + 465/587)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            python - <<'PY'
            import os, glob, json, ssl, smtplib
            from email.mime.text import MIMEText

            user = os.getenv("SMTP_USER","").strip()
            pwd  = os.getenv("SMTP_PASS","").strip()
            to   = os.getenv("SMTP_TO","").strip()

            if not user or not pwd or not to:
                raise SystemExit("SMTP env missing: check secrets mapping")

            # 读取最新 summary
            summary = ""
            candidates = sorted(
                glob.glob("data/summary_*.json") + glob.glob("**/data/summary_*.json", recursive=True),
                key=lambda p: os.path.getmtime(p),
                reverse=True
            )
            if candidates:
                p = candidates[0]
                try:
                    with open(p, "r", encoding="utf-8") as f:
                        summary_json = json.load(f)
                    summary = json.dumps(summary_json, ensure_ascii=False, indent=2)
                except Exception as e:
                    summary = f"Found {p} but failed to read: {e}"
            else:
                summary = "No summary file found. This is a SMTP test mail."

            msg = MIMEText("=== Summary ===\n" + summary + "\n", "plain", "utf-8")
            msg["Subject"] = "ETF Auto Trader Report (GitHub Actions)"
            msg["From"] = user
            msg["To"] = to

            host = "smtp.qq.com"
            ctx = ssl.create_default_context()

            def send_via_465():
                with smtplib.SMTP_SSL(host, 465, context=ctx, timeout=30) as s:
                    s.ehlo()
                    s.login(user, pwd)
                    s.sendmail(user, [to], msg.as_string())

            def send_via_587():
                with smtplib.SMTP(host, 587, timeout=30) as s:
                    s.ehlo()
                    s.starttls(context=ctx)
                    s.ehlo()
                    s.login(user, pwd)
                    s.sendmail(user, [to], msg.as_string())

            # 先 465，失败再 587（在 retry 包裹下会自动再试）
            try:
                send_via_465()
                print("Email sent via 465 SSL.")
            except Exception as e1:
                print(f"465 failed: {type(e1).__name__}: {e1}")
                send_via_587()
                print("Email sent via 587 STARTTLS.")
            PY
