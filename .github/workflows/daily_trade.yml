name: ETF Auto Trader

on:
  workflow_dispatch:
  schedule:
    # 北京时间 08:50（UTC 00:50）周一到周五：主触发
    - cron: "50 0 * * 1-5"
    # 北京时间 09:10（UTC 01:10）周一到周五：保险触发（仅在 08:50 没跑成功时补救）
    - cron: "10 1 * * 1-5"

jobs:
  run_daily:
    runs-on: ubuntu-latest

    env:
      TZ: Asia/Shanghai
      # 让脚本读到它期望的环境变量名
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASSWORD }}
      SMTP_TO: ${{ secrets.TO_EMAIL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 恢复“今日已跑”标记（跨两次 schedule）
      - name: Restore sent-flag cache
        uses: actions/cache@v4
        with:
          path: .sent-flag
          key: sent-flag-${{ github.repository }}-${{ runner.os }}-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            sent-flag-${{ github.repository }}-${{ runner.os }}-${{ github.ref_name }}-

      - name: Compute today key (Beijing)
        id: today
        run: |
          echo "TODAY=$(date +%F)" >> $GITHUB_OUTPUT
          echo "Beijing TODAY=$(date +%F) NOW=$(date '+%F %T %z')"

      # 检查今天是否已经跑过；跑过则后续全部跳过（避免 09:10 再发一封）
      - name: Check already ran today
        id: already
        run: |
          set -e
          mkdir -p .sent-flag
          TODAY="${{ steps.today.outputs.TODAY }}"
          if [ -f ".sent-flag/${TODAY}.ok" ]; then
            echo "ALREADY_RAN=1" >> $GITHUB_OUTPUT
            echo "Already ran today: ${TODAY}"
          else
            echo "ALREADY_RAN=0" >> $GITHUB_OUTPUT
            echo "Not ran yet today: ${TODAY}"
          fi

      - name: Check email env (length only)
        if: steps.already.outputs.ALREADY_RAN != '1'
        run: |
          python - <<'PY'
          import os
          for k in ["SMTP_USER","SMTP_PASS","SMTP_TO"]:
              v = os.getenv(k, "")
              print(f"{k}: {'OK' if v else 'MISSING'} len={len(v)}")
          PY

      # 只跑一次脚本（脚本会自己发“日报格式”那封邮件）
      - name: Run daily trader script
        if: steps.already.outputs.ALREADY_RAN != '1'
        run: |
          python ./scripts/run_daily.py

      # 标记今日已跑（这样 09:10 会自动跳过，避免第二封邮件）
      - name: Mark ran today
        if: steps.already.outputs.ALREADY_RAN != '1'
        run: |
          TODAY="${{ steps.today.outputs.TODAY }}"
          mkdir -p .sent-flag
          echo "ok" > ".sent-flag/${TODAY}.ok"
          echo "Marked ran: ${TODAY}"

      # 保存标记到 cache，供 09:10 读取
      - name: Save sent-flag cache
        if: steps.already.outputs.ALREADY_RAN != '1'
        uses: actions/cache/save@v4
        with:
          path: .sent-flag
          key: sent-flag-${{ github.repository }}-${{ runner.os }}-${{ github.ref_name }}-${{ github.run_id }}
